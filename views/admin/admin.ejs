<!DOCTYPE html>
<!-- ===== Page: Admin Dashboard ===== -->
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Home4Pets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="/style.css">
</head>
<body class="minimal-theme">

<nav class="navbar">
  <div class="d-flex align-items-center gap-2">
    <img src="/logo.png" alt="Logo" style="height: 30px; margin-right: 8px;"> <a href="/" style="text-decoration: none;"><span class="navbar-brand">Home4Pets</span></a>
  </div>

  <div class="d-flex align-items-center">
    <a class="nav-link admin-top-link <%= activeTab === 'pets' ? 'active' : '' %>" href="/admin?tab=pets" data-tab="pets">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</a>
    <a class="nav-link admin-top-link <%= activeTab === 'search' ? 'active' : '' %>" href="/admin?tab=search" data-tab="search">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå</a>
    <a class="nav-link admin-top-link <%= activeTab === 'settings' ? 'active' : '' %>" href="/admin?tab=settings" data-tab="settings">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>

    <div class="user-badge ms-3">
      <span><%= user.name %></span>
      <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png">
    </div>
  </div>
</nav>

<!-- Dashboard Header -->
<div class="admin-header" style="background-image: url('/banner.png'); background-size: cover; background-position: center;">
  <h2>Dashboard</h2>
</div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-3">
      <div class="admin-sidebar">
        <button class="admin-menu <%= activeTab === 'pets' ? 'active' : '' %>" onclick="showTab('pets')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</button>
        <button class="admin-menu <%= activeTab === 'search' ? 'active' : '' %>" onclick="showTab('search')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
        <button class="admin-menu <%= activeTab === 'settings' ? 'active' : '' %>" onclick="showTab('settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
      </div>
    </div>

    <!-- Content -->
    <div class="col-9">
      <!-- Tab 1: Manage Pets -->
      <div id="petsTab" class="admin-tab" style="display: <%= activeTab === 'pets' ? 'block' : 'none' %>;">
        <h5 class="mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á <button class="btn btn-add" onclick="location.href='/admin/add-pet'">+ Add Pet</button></h5>
        
        <div class="pet-list">
          <% pets.forEach(pet => { %>
          <div class="pet-item">
            <img src="<%= pet.image %>" alt="Pet">
            <div class="pet-details">
              <h6><%= pet.name %></h6>
              <p>
                <%= pet.type === 'cats' ? '‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß' : '‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' %> ‡∏£‡∏´‡∏±‡∏™: <%= pet.petId || pet.id %><br>
                <%= (pet.gender === 'female' || pet.gender === '‚ôÄ') ? '‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢' : '‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ' %>
                ‡∏≠‡∏≤‡∏¢‡∏∏ <%= pet.age %>
                <br>
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: <%= pet.createdAt ? new Date(pet.createdAt).toLocaleString('th-TH') : '-' %>
              </p>
              <div class="pet-status">
                <span class="status-health <%= pet.adoptionStatus === 'adopted' ? 'status-adopted' : '' %>">
                  <%= pet.adoptionStatus === 'adopted' ? '‚úó ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‚úì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' %>
                </span>
                <span class="status-post <%= pet.postStatus === 'close' ? 'status-closed' : 'status-open' %>">
                  <%= pet.postStatus === 'close' ? '‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' %>
                </span>
              </div>
            </div>
            <div class="d-flex gap-2">
              <form action="/admin/toggle-post-status" method="POST">
                <input type="hidden" name="id" value="<%= pet.id %>">
                <input type="hidden" name="nextStatus" value="<%= pet.postStatus === 'open' ? 'close' : 'open' %>">
                <input type="hidden" name="tab" value="pets">
                <button type="submit" class="btn btn-secondary">
                  <%= pet.postStatus === 'open' ? '‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' %>
                </button>
              </form>
              <button class="btn btn-edit" onclick="location.href='/admin/edit-pet?id=<%= pet.id %>'">Edit</button>
              <form action="/admin/delete-pet" method="POST" onsubmit="return confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');">
                <input type="hidden" name="id" value="<%= pet.id %>">
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          </div>
          <% }); %>
        </div>
      </div>

      <!-- Tab 2: Add Pet -->
      <div id="searchTab" class="admin-tab" style="display: <%= activeTab === 'search' ? 'block' : 'none' %>;">
        <div class="admin-search-card">
          <h5 class="admin-search-title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå</h5>
          <form class="filter-form admin-search-form" method="GET" action="/admin">
            <input type="hidden" name="tab" value="search">
            <div class="filter-row admin-search-row-2">
              <input class="filter-input" type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á" value="<%= filters?.name || '' %>">
              <input class="filter-input" type="text" name="pet_id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡∏ï‡∏ß‡πå ID" value="<%= filters?.pet_id || '' %>">
            </div>

            <div class="filter-row admin-search-row-4">
              <select class="filter-input" name="type">
                <option value="">-‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î-</option>
                <option value="dogs" <%= filters?.type === 'dogs' ? 'selected' : '' %>>Dogs</option>
                <option value="cats" <%= filters?.type === 'cats' ? 'selected' : '' %>>Cats</option>
              </select>

              <select class="filter-input" name="age">
                <option value="">-‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î-</option>
                <option value="0-1" <%= filters?.age === '0-1' ? 'selected' : '' %>>0-1 years</option>
                <option value="1-3" <%= filters?.age === '1-3' ? 'selected' : '' %>>1-3 years</option>
                <option value="3-5" <%= filters?.age === '3-5' ? 'selected' : '' %>>3-5 years</option>
                <option value="5+" <%= filters?.age === '5+' ? 'selected' : '' %>>5 years+</option>
              </select>

              <select class="filter-input" name="gender">
                <option value="">-‡πÄ‡∏û‡∏®‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î-</option>
                <option value="male" <%= filters?.gender === 'male' ? 'selected' : '' %>>Male</option>
                <option value="female" <%= filters?.gender === 'female' ? 'selected' : '' %>>Female</option>
              </select>

              <select class="filter-input" name="sterilized">
                <option value="">-‡∏ó‡∏≥‡∏´‡∏°‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î-</option>
                <option value="yes" <%= filters?.sterilized === 'yes' ? 'selected' : '' %>>‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="no" <%= filters?.sterilized === 'no' ? 'selected' : '' %>>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</option>
              </select>
            </div>

            <div class="filter-row admin-search-row-3">
              <select class="filter-input" name="color">
                <option value="">-‡∏™‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î-</option>
                <option value="White" <%= filters?.color === 'White' ? 'selected' : '' %>>White</option>
                <option value="Black" <%= filters?.color === 'Black' ? 'selected' : '' %>>Black</option>
                <option value="Brown" <%= filters?.color === 'Brown' ? 'selected' : '' %>>Brown</option>
                <option value="Gray" <%= filters?.color === 'Gray' ? 'selected' : '' %>>Gray</option>
                <option value="Orange" <%= filters?.color === 'Orange' ? 'selected' : '' %>>Orange</option>
                <option value="Calico" <%= filters?.color === 'Calico' ? 'selected' : '' %>>Calico</option>
                <option value="Tabby" <%= filters?.color === 'Tabby' ? 'selected' : '' %>>Tabby</option>
              </select>

              <select class="filter-input" name="adoption_status">
                <option value="">-‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á-</option>
                <option value="available" <%= filters?.adoption_status === 'available' ? 'selected' : '' %>>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</option>
                <option value="adopted" <%= filters?.adoption_status === 'adopted' ? 'selected' : '' %>>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß</option>
              </select>

              <select class="filter-input" name="post_status">
                <option value="">-‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå-</option>
                <option value="open" <%= filters?.post_status === 'open' ? 'selected' : '' %>>‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå</option>
                <option value="close" <%= filters?.post_status === 'close' ? 'selected' : '' %>>‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå</option>
              </select>

              <button class="search-btn admin-search-btn" type="submit">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>
          </form>
        </div>

        <div class="pet-list" style="margin-top: 24px;">
          <% if (pets.length === 0) { %>
            <div class="text-center text-muted" style="padding: 20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          <% } %>
          <% pets.forEach(pet => { %>
          <div class="pet-item">
            <img src="<%= pet.image %>" alt="Pet">
            <div class="pet-details">
              <h6><%= pet.name %></h6>
              <p>
                <%= pet.type === 'cats' ? '‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏°‡∏ß' : '‡∏ô‡πâ‡∏≠‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç' %> ‡∏£‡∏´‡∏±‡∏™: <%= pet.petId || pet.id %><br>
                <%= (pet.gender === 'female' || pet.gender === '‚ôÄ') ? '‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢' : '‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ' %>
                ‡∏≠‡∏≤‡∏¢‡∏∏ <%= pet.age %>
                <br>
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: <%= pet.createdAt ? new Date(pet.createdAt).toLocaleString('th-TH') : '-' %>
              </p>
            </div>
            <div class="d-flex gap-2">
              <form action="/admin/toggle-post-status" method="POST">
                <input type="hidden" name="id" value="<%= pet.id %>">
                <input type="hidden" name="nextStatus" value="<%= pet.postStatus === 'open' ? 'close' : 'open' %>">
                <input type="hidden" name="tab" value="search">
                <button type="submit" class="btn btn-secondary">
                  <%= pet.postStatus === 'open' ? '‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå' %>
                </button>
              </form>
              <button class="btn btn-edit" onclick="location.href='/admin/edit-pet?id=<%= pet.id %>'">Edit</button>
              <form action="/admin/delete-pet" method="POST" onsubmit="return confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');">
                <input type="hidden" name="id" value="<%= pet.id %>">
                <button type="submit" class="btn btn-danger">Delete</button>
              </form>
            </div>
          </div>
          <% }); %>
        </div>
      </div>

      <!-- Tab 3: Settings -->
      <div id="settingsTab" class="admin-tab" style="display: <%= activeTab === 'settings' ? 'block' : 'none' %>;">
        <h5 class="mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h5>
        
        <div class="settings-content">
          <div class="mb-4">
            <button class="btn btn-primary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#changePasswordForm" aria-expanded="false" aria-controls="changePasswordForm">
              ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Change Password)
            </button>

            <div class="collapse" id="changePasswordForm">
              <% if (settingsError) { %>
                <div class="alert alert-danger"><%= settingsError %></div>
              <% } %>
              <% if (settingsSuccess) { %>
                <div class="alert alert-success"><%= settingsSuccess %></div>
              <% } %>

              <form method="POST" action="/admin/change-password" class="row g-3">
                <div class="col-md-6">
                  <input type="password" name="currentPassword" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" required>
                </div>
                <div class="col-md-6"></div>
                <div class="col-md-6">
                  <input type="password" name="newPassword" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" required>
                </div>
                <div class="col-md-6">
                  <input type="password" name="confirmPassword" class="form-control" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" required>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                </div>
              </form>
            </div>
          </div>

          <div>
            <button class="btn btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#loginActivityTable" aria-expanded="false" aria-controls="loginActivityTable">
              ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Login Activity)
            </button>
            <div class="collapse" id="loginActivityTable">
              <% if (loginActivity && loginActivity.length > 0) { %>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                        <th>IP</th>
                        <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% loginActivity.forEach(activity => { %>
                        <tr>
                          <td><%= new Date(activity.loggedInAt).toLocaleString('th-TH') %></td>
                          <td><%= activity.ipAddress || '-' %></td>
                          <td style="max-width: 420px; white-space: normal;"><%= activity.userAgent || '-' %></td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
              <% } %>
            </div>
          </div>
          <a href="/logout" class="btn btn-danger" style="display: inline-block; margin-top: 20px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Logout)</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function showTab(tabName) {
  // Hide all tabs
  document.getElementById('petsTab').style.display = 'none';
  document.getElementById('searchTab').style.display = 'none';
  document.getElementById('settingsTab').style.display = 'none';

  // Remove active class from all buttons
  var buttons = document.querySelectorAll('.admin-menu');
  buttons.forEach(function(btn) {
    btn.classList.remove('active');
  });

  // Sync top nav state
  var topLinks = document.querySelectorAll('.admin-top-link');
  topLinks.forEach(function(link) {
    link.classList.toggle('active', link.dataset.tab === tabName);
  });

  // Show selected tab and mark button as active
  if (tabName === 'pets') {
    document.getElementById('petsTab').style.display = 'block';
    buttons[0].classList.add('active');
  } else if (tabName === 'search') {
    document.getElementById('searchTab').style.display = 'block';
    buttons[1].classList.add('active');
  } else if (tabName === 'settings') {
    document.getElementById('settingsTab').style.display = 'block';
    buttons[2].classList.add('active');
  }

  // Update URL without full reload
  try {
    var nextUrl = new URL(window.location.href);
    nextUrl.searchParams.set('tab', tabName);
    window.history.replaceState({}, '', nextUrl.toString());
  } catch (err) {
    // ignore URL update errors
  }
}
</script>

</body>
</html>
